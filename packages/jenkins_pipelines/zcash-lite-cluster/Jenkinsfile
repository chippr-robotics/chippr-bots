def secrets = [
        [path: 'secret/COMMON', engineVersion: 2, secretValues: [
            [envVar: 'GIT_CRED', vaultKey: 'GIT_CRED'],
            [envVar: 'GIT_URL', vaultKey: 'GIT_URL'],
            [envVar: 'SERVER_URL', vaultKey: 'SERVER_URL']
            ]],
        [path: 'secret/ZCASH_LITE', engineVersion: 2, secretValues: [
            [envVar: 'ZCASHD_IMAGE', vaultKey: 'ZCASHD_IMAGE']
            ]]
    ]
def configuration = [vaultUrl: 'http://192.168.1.135:8200',
                         vaultCredentialId: 'vault-token',
                         engineVersion: 2]
    

pipeline {
    agent any
  
    stages {
        stage('ZCASH_LITE_CLUSTER_START - Checkout') {
            steps {
    	    withVault([configuration: configuration, vaultSecrets: secrets]) {
    	        checkout([
                    $class: 'GitSCM', 
                    branches: 
                        [[name: 'refs/heads/primary']],
                        doGenerateSubmoduleConfigurations: 
                            false,
                            extensions: [[$class: 'CloneOption', timeout: 120]], 
                            submoduleCfg: [], 
                            userRemoteConfigs: 
                                [[
                                    credentialsId: env.GIT_CRED, 
                                    url: env.GIT_URL
                                ]]
                ]) 
            }}
        }

        stage('ZCASH_LITE_CLUSTER_START - Build') {
            steps {
        	    withVault([configuration: configuration, vaultSecrets: secrets]) {
                    sh 'docker pull $ZCASHD_IMAGE'
        	    }
            }
    	}

        stage('ZCASH_LITE_CLUSTER_START - Purge') {
            steps{
                sh """
                    cd "${env.WORKSPACE}/packages/compose/zcash-lite-cluster/"
                    docker-compose down  || echo "No service running"
                    sleep 10s 
                """
            }
        }
    
        stage('ZCASH_LITE_CLUSTER_START - Boot') {
    	   steps{
    	       withVault([configuration: configuration, vaultSecrets: secrets]) {
                    sh 'export ZCASHD_PRIME_NODE=$SERVER_URL:38232' 
    	       }
    	       sh """
    	            cd "${env.WORKSPACE}/packages/compose/zcash-lite-cluster/" 
    	            docker-compose up -d
    	       """
    	    }
        }
    }//STAGES
} //PIPELINE

post {
    changed {
        withCredentials([string(credentialsId: 'discord_webhook', variable: 'WEBHOOK')]) {
            discordSend description: 'Jenkins Pipeline Build', 
            link: BUILD_URL, 
            successful: currentBuild.resultIsBetterOrEqualTo('SUCCESS'), 
            title: JOB_NAME, 
            webhookURL: WEBHOOK
        }
    }
} //POST
