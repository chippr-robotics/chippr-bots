pipeline {

agent any

environment {
    // common environment
    GIT_CRED = vault path: 'secrets/COMMON', key: 'GIT_CRED', vaultUrl: 'https://192.168.1.135:8200', credentialsId: 'vault-root-token', engineVersion: "2"
    GIT_URL = vault path: 'secrets/COMMON', key: 'GIT_URL', vaultUrl: 'https://192.168.1.135:8200', credentialsId: 'vault-root-token', engineVersion: "2"
    SERVER_URL = vault path: 'secrets/COMMON', key: 'SERVER_URL', vaultUrl: 'https://192.168.1.135:8200', credentialsId: 'vault-root-token', engineVersion: "2"
    LOG_LEVEL='debug'
    
    // pipeline configuration

    }

timestamps {
    stages {
        stage('ZCASH_LITE_CLUSTER_START - Checkout') {
            steps {
    	        checkout([
                    $class: 'GitSCM', 
                    branches: 
                        [[name: 'refs/heads/primary']],
                        doGenerateSubmoduleConfigurations: 
                            false,
                            extensions: [], 
                            submoduleCfg: [], 
                            userRemoteConfigs: 
                                [[
                                    credentialsId: env.GIT_CRED, 
                                    url: env.GIT_URL
                                ]]
                ]) 
            }
        }

        stage('ZCASH_LITE_CLUSTER_START - Build') {
            steps {
                sh 'docker pull "${env.ZCASHD_IMAGE}"'
            }
        }

        stage('ZCASH_LITE_CLUSTER_START - Purge') {
            steps{
                sh """
                    cd "${env.WORKSPACE}/packages/compose/zcash-lite-cluster/"
                    docker-compose down  || echo "No service running"
                    sleep 10s 
                """
            }
        }
    
        stage('ZCASH_LITE_CLUSTER_START - Boot') {
            steps{
                sh """
                    cd "${env.WORKSPACE}/packages/compose/zcash-lite-cluster/"
                    export ZCASHD_PRIME_NODE="${env.SERVER_URL}":38232 #$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' zcash_zcashd_1)":38232"
                    docker-compose up -d 
                """
            }
        }
    }//STAGES
} //TIMESTAMPS

    post {
        changed {
            withCredentials([string(credentialsId: 'discord_webhook', variable: 'WEBHOOK')]) {
                discordSend description: 'Jenkins Pipeline Build', 
                link: BUILD_URL, 
                successful: currentBuild.resultIsBetterOrEqualTo('SUCCESS'), 
                title: JOB_NAME, 
                webhookURL: WEBHOOK
            }
        }
    } //POST
} //PIPELINE